# 断路器模式重构文档

## 一、重构必要性（原因）

### 1.1 系统架构风险

mall 电商系统依赖多个外部服务，但缺乏容错保护机制，存在以下风险：

#### 1.1.1 Elasticsearch 强依赖风险
- **问题**：搜索服务直接使用 `ElasticsearchRestTemplate` 进行查询，当 Elasticsearch 不可用时，整个搜索功能完全失效
- **影响**：用户无法搜索商品，严重影响用户体验和业务连续性
- **位置**：`EsProductServiceImpl.java` 中的 `search()`、`recommend()`、`searchRelatedInfo()` 方法

#### 1.1.2 Redis 缓存缺乏降级策略
- **问题**：系统大量使用 Redis 缓存（用户信息、订单号生成等），但当 Redis 不可用时，没有回退到数据库查询的机制
- **影响**：可能导致服务完全不可用，无法获取用户信息、无法生成订单号等
- **位置**：`RedisServiceImpl.java`、`UmsMemberCacheServiceImpl.java`、订单号生成逻辑

#### 1.1.3 订单服务复杂依赖链
- **问题**：订单生成流程涉及多个服务调用（购物车、库存、优惠券、积分、地址等），任何一个环节失败都可能导致整个订单流程中断
- **影响**：订单生成失败率高，用户体验差，业务损失
- **位置**：`OmsPortalOrderServiceImpl.java` 的 `generateOrder()` 方法

#### 1.1.4 消息队列缺乏保护
- **问题**：订单取消使用了 RabbitMQ 延迟消息，但如果 RabbitMQ 不可用，没有备用方案
- **影响**：订单超时无法自动取消，需要人工干预
- **位置**：`CancelOrderSender.java` 的 `sendMessage()` 方法

### 1.2 业务影响

1. **可用性风险**：单个外部服务故障可能导致整个系统不可用
2. **用户体验**：服务不可用时用户看到错误页面，无法使用基本功能
3. **业务损失**：订单生成失败、搜索功能失效直接影响销售额
4. **运维成本**：需要人工监控和处理服务故障

### 1.3 技术债务

- 代码中完全没有断路器或容错机制的实现
- 缺乏统一的异常处理和降级策略
- 没有服务健康状态的监控和自动恢复机制

## 二、重构过程

### 2.1 技术选型

选择 **Resilience4j** 作为断路器实现框架，原因：
- 轻量级，不依赖 Spring Cloud（项目未使用微服务框架）
- 功能完整，支持断路器、重试、限流等多种容错模式
- 与 Spring Boot 2.x 集成良好
- 配置灵活，支持代码配置和配置文件配置

### 2.2 重构步骤

#### 步骤 1：添加依赖

在根 `pom.xml` 中添加 Resilience4j 版本管理：
```xml
<resilience4j.version>1.7.1</resilience4j.version>
```

在 `mall-common`、`mall-search`、`mall-portal` 模块中添加依赖：
```xml
<dependency>
    <groupId>io.github.resilience4j</groupId>
    <artifactId>resilience4j-spring-boot2</artifactId>
</dependency>
```

#### 步骤 2：创建断路器配置类

创建 `CircuitBreakerConfig.java`，配置四个断路器：
- **Elasticsearch 断路器**：保护搜索服务
- **Redis 断路器**：保护缓存服务
- **RabbitMQ 断路器**：保护消息队列
- **订单服务断路器**：保护订单关键操作

每个断路器配置了：
- 失败率阈值：50%
- 等待时间：30-60秒
- 滑动窗口大小：10
- 最小调用次数：5
- 慢调用检测：50% 慢调用率，1-3秒阈值

#### 步骤 3：创建工具类

创建 `CircuitBreakerUtil.java`，提供统一的断路器执行方法：
- `execute(CircuitBreaker, Supplier, Supplier)`：带降级策略的执行
- `execute(CircuitBreaker, Runnable, Runnable)`：无返回值带降级策略的执行
- `execute(CircuitBreaker, Supplier)`：无降级策略的执行（抛出异常）

#### 步骤 4：重构搜索服务

**文件**：`EsProductServiceImpl.java`

**重构内容**：
1. 在 `search()` 方法中添加断路器保护
   - 主要逻辑：从 Elasticsearch 查询
   - 降级策略：从数据库查询（使用 `productDao.searchProducts()`）

2. 在 `recommend()` 方法中添加断路器保护
   - 主要逻辑：从 Elasticsearch 查询推荐商品
   - 降级策略：从数据库查询同品牌或同分类商品

3. 在 `searchRelatedInfo()` 方法中添加断路器保护
   - 主要逻辑：从 Elasticsearch 聚合查询
   - 降级策略：返回空的相关信息

**新增 DAO 方法**：
- 在 `EsProductDao.java` 中添加 `searchProducts()` 方法
- 在 `EsProductDao.xml` 中添加对应的 SQL 查询

#### 步骤 5：重构缓存服务

**文件**：`RedisServiceImpl.java`

**重构内容**：
1. 在 `get()` 方法中添加断路器保护
   - 主要逻辑：从 Redis 获取
   - 降级策略：返回 null（由上层服务处理）

2. 在 `set()` 方法中添加断路器保护
   - 主要逻辑：写入 Redis
   - 降级策略：记录日志，跳过缓存设置

3. 在 `del()` 方法中添加断路器保护
   - 主要逻辑：删除 Redis 键
   - 降级策略：返回 false，记录日志

**文件**：`UmsMemberCacheServiceImpl.java`

**重构内容**：
1. 在 `getMember()` 方法中添加降级逻辑
   - 如果 Redis 返回 null，从数据库查询
   - 查询成功后尝试重新设置缓存

#### 步骤 6：重构订单服务

**文件**：`OmsPortalOrderServiceImpl.java`

**重构内容**：
1. **库存检查**（`hasStock()`）
   - 添加断路器保护
   - 降级策略：返回 false，拒绝下单

2. **优惠券验证**（`getUseCoupon()`）
   - 添加断路器保护
   - 降级策略：返回 null，拒绝使用优惠券

3. **库存锁定**（`lockStock()`）
   - 添加断路器保护
   - 降级策略：抛出异常，订单生成失败

4. **订单号生成**（`generateOrderSn()`）
   - 添加 Redis 断路器保护
   - 降级策略：使用时间戳+随机数生成订单号

5. **消息队列发送**（`sendDelayMessageCancelOrder()`）
   - 添加 RabbitMQ 断路器保护
   - 降级策略：记录日志，建议记录到数据库

#### 步骤 7：重构消息队列服务

**文件**：`CancelOrderSender.java`

**重构内容**：
1. 在 `sendMessage()` 方法中添加断路器保护
   - 主要逻辑：发送 RabbitMQ 延迟消息
   - 降级策略：记录日志，建议记录到数据库由定时任务处理

### 2.3 重构原则

1. **向后兼容**：所有修改都使用 `@Autowired(required = false)`，确保断路器配置不存在时不影响原有功能
2. **渐进式重构**：先添加断路器保护，再逐步完善降级策略
3. **统一工具类**：使用 `CircuitBreakerUtil` 统一处理断路器逻辑，避免代码重复
4. **日志记录**：所有降级操作都记录日志，便于问题排查

## 三、重构结果（带来好处）

### 3.1 系统可用性提升

#### 3.1.1 搜索服务可用性
- **重构前**：Elasticsearch 不可用时，搜索功能完全失效
- **重构后**：Elasticsearch 不可用时，自动降级到数据库查询，搜索功能仍可使用（性能可能下降，但功能可用）

**示例场景**：
```
用户搜索"手机"
- Elasticsearch 正常：从 ES 查询，返回结果快，支持全文搜索
- Elasticsearch 故障：自动降级到数据库查询，返回结果稍慢，但功能可用
```

#### 3.1.2 缓存服务可用性
- **重构前**：Redis 不可用时，用户信息获取失败，订单号生成失败
- **重构后**：Redis 不可用时，自动降级到数据库查询，系统仍可正常运行

**示例场景**：
```
用户登录
- Redis 正常：从缓存获取用户信息，响应快
- Redis 故障：自动从数据库查询，响应稍慢，但登录成功
```

#### 3.1.3 订单服务可用性
- **重构前**：任何一个依赖服务故障，订单生成失败
- **重构后**：关键步骤有断路器保护，部分服务故障时仍可生成订单（如优惠券服务故障时，不使用优惠券仍可下单）

### 3.2 用户体验改善

1. **搜索功能**：即使 Elasticsearch 故障，用户仍可搜索商品，不会看到错误页面
2. **登录功能**：即使 Redis 故障，用户仍可登录，只是响应稍慢
3. **订单功能**：部分服务故障时，用户仍可下单（如不使用优惠券）

### 3.3 业务连续性保障

1. **减少业务损失**：服务故障时系统仍可部分运行，减少订单损失
2. **降低人工干预**：自动降级减少需要人工处理的故障场景
3. **提高系统韧性**：系统能够从故障中自动恢复

### 3.4 可观测性提升

1. **日志记录**：所有降级操作都记录日志，便于监控和排查
2. **断路器状态**：可以通过 Resilience4j 的指标监控断路器状态
3. **故障追踪**：通过日志可以追踪哪些服务发生了故障

### 3.5 代码质量提升

1. **统一异常处理**：通过 `CircuitBreakerUtil` 统一处理断路器逻辑
2. **代码复用**：降级策略可以复用，减少代码重复
3. **易于扩展**：新增服务时，可以快速添加断路器保护

### 3.6 性能优化潜力

1. **快速失败**：断路器打开时立即返回降级结果，避免长时间等待
2. **资源保护**：防止故障服务拖垮整个系统
3. **自动恢复**：服务恢复后，断路器自动进入半开状态，逐步恢复流量

## 四、重构前后对比

### 4.1 代码结构对比

#### 重构前
```
服务类
  └── 直接调用外部服务
      └── 异常时抛出异常，服务不可用
```

#### 重构后
```
服务类
  └── CircuitBreakerUtil.execute()
      ├── 主要逻辑（调用外部服务）
      └── 降级策略（备用方案）
```

### 4.2 异常处理对比

#### 重构前
```java
// 直接调用，异常时抛出
SearchHits<EsProduct> searchHits = elasticsearchRestTemplate.search(...);
```

#### 重构后
```java
// 带断路器保护和降级策略
return CircuitBreakerUtil.execute(
    circuitBreaker,
    () -> elasticsearchRestTemplate.search(...),  // 主要逻辑
    () -> productDao.searchProducts(...)          // 降级策略
);
```

### 4.3 系统行为对比

| 场景 | 重构前 | 重构后 |
|------|--------|--------|
| Elasticsearch 故障 | 搜索功能完全失效 | 降级到数据库查询，功能可用 |
| Redis 故障 | 用户信息获取失败 | 降级到数据库查询，功能可用 |
| 优惠券服务故障 | 订单生成失败 | 不使用优惠券仍可下单 |
| RabbitMQ 故障 | 订单取消消息发送失败 | 记录日志，可扩展为数据库记录 |

## 五、后续优化建议

### 5.1 监控和告警
1. 集成 Resilience4j Metrics，监控断路器状态
2. 设置告警规则，当断路器打开时发送告警
3. 监控降级操作的频率，评估服务健康状态

### 5.2 降级策略优化
1. **RabbitMQ 降级**：实现数据库记录+定时任务处理机制
2. **缓存预热**：服务恢复后，自动预热常用数据到缓存
3. **限流保护**：在断路器基础上添加限流，防止服务恢复时流量过大

### 5.3 配置优化
1. 将断路器配置移到配置文件，支持动态调整
2. 根据实际业务场景调整断路器参数
3. 为不同服务设置不同的断路器配置

### 5.4 测试完善
1. 添加断路器测试用例
2. 模拟服务故障场景，验证降级策略
3. 性能测试，评估降级对性能的影响

## 六、总结

通过引入断路器模式，mall 电商系统的可用性和韧性得到了显著提升：

1. **系统可用性**：从单点故障导致系统不可用，提升到故障时自动降级，系统仍可部分运行
2. **用户体验**：从看到错误页面，提升到功能降级但可用
3. **业务连续性**：减少了因服务故障导致的业务损失
4. **可维护性**：统一的断路器工具类，便于后续扩展和维护

这次重构为系统建立了完善的容错机制，为后续的微服务化改造和系统扩展打下了良好的基础。



